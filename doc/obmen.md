# Формат обмена между Дартс-базой и сервером

Клиент 1 - Приложение Дартс-База, инициатор игры
Клиент 2 - Приложение Дартс-База, отвечающий игрок. 
Игрок 1 - Имя игрока на Клиенте 1
Игрок 2 - Имя игрока на клиенте 2

## Формат запроса

Обмен между клиентом и сервером идёт в формате json, обязателен аттрибут stage, в зависимости от стадии процесса.
```json
{
    "key":"value",
}
```

## stage - допустимые состояния

### register

Стадия регистрации.
Дартс-база формирует запрос в виде:
Формат:
```json
{
    "stage": "register", 
    "guid": "ac922d72-2963-ab41-8d36-b954f658d71c",
    "game": "x01",
    "playerName": "Mark"
}
```
где, 
stage - аттрибут стадии
guid - GUID игры создающего игру клиента
game - типа игры, допустимые значения x01, Cricket
playerName - имя Игрока 1

В ответ на запрос возвращается Ключ игры, который используется для согласования игры с вторым клиентом: 5 символов, регистрозависимы, например: "Dj4mE". Ключ необходимо сообщить удаленному игроку. 

После получения ключа Клиент 1 переходит в состояние *wait*

### answer
Стадия регистрации второго клиента. 
```json
{ 
    "stage": "answer", 
    "key": "Dj4mE", 
    "guid": "8c414046-51a9-1345-a9f1-5f2f136f8711", 
    "playerName": "Savage" 
}
```
где, 
stage - аттрибут стадии 
key - ключ игры полученный от инициатора игры
guid - GUID игры клиента желающего сыграть. 
playerName - имя игрока 2

В ответ на запрос Клиент 2 получает имя Игрока 1

### wait
Стадия согласования данных и начала игры
```json
{ 
    "stage": "wait", 
    "key": "Dj4mE", 
    "guid": ""
}
```
где, 
stage - аттрибут стадии 
key - ключ игры полученный от инициатора игры
guid - GUID игры первого или второго Клиента

В ответ Клиенту 1 будет отправлено имя Игрока 2, после получения Игрока 2, Клиент 1 инициализирует игру, стадией *setGame*

Клиенту 2 отправляется ответ с настройками игры, полученными от Клиента 1:
```json
{
    "bestOf": 0, 
    "beginGame": 2, 
    "firstToLegs": 4, 
    "firstToSets": 1, 
    "doublesCount": true, 
    "startScores1": 501, 
    "startScores2": 451
}
```

### setGame

*x01*
```json
{ 
    "stage": "setGame", 
    "key": "Dj4mE", 
    "beginGame": 2, 
    "firstToSets": 1, 
    "firstToLegs": 3, 
    "bestOf": 0, 
    "doublesCount": true, 
    "startScores1": 501, 
    "startScores2": 451 
}
```

где, 
stage - аттрибут стадии
key - ключ игры
beginGame - номер начинающего игрока, 1 - Клиент 1 (Игрок 1), 2 - Клиент 2 (Игрок 2)
firstToSets - до победы в *value* сетах
firstToLegs - первый до *value* легах
bestOf - лучший из *value* легов
doublesCount - признак подсчет даблов при закрытии (для расширенной статистики на клиентах)
startScores1 - начальное кол-во очков для Игрока 1
startScores2 - начальное кол-во очков для Игрока 2


*Cricket*

```json
{ 
    "stage": "setGame", 
    "key": "Dj4mE", 
    "beginGame": 2, 
    "firstToSets": 1, 
    "firstToLegs": 3, 
    "bestOf": 0, 
    "cricketWithScores": true
}
```

где, 
stage - аттрибут стадии
key - ключ игры
beginGame - номер начинающего игрока, 1 - Клиент 1 (Игрок 1), 2 - Клиент 2 (Игрок 2)
firstToSets - до победы в *value* сетах
firstToLegs - первый до *value* легах
bestOf - лучший из *value* легов
cricketWithScores - признак игры с набором очков



В ответ на успешный запрос Клиент 1 получает ответ 'OK'

### game

Клиенты 1 и 2 может послать 2 разных запроса

Набор для отпраки опоненту: 

Стандартный запрос 

x01
```json
{ 
    "stage": "game", 
    "key": "Dj4mE", 
    "guid": "8c414046-51a9-1345-a9f1-5f2f136f8711", 
    "score": 100, 
    "require": 351, 
    "darts": 3, 
    "doubleAttempts": 0 
}
```

где, 
stage - аттрибут стадии 
key - ключ игры полученный от инициатора игры
guid - GUID игры первого или второго Клиента
score - набор в подходе
require - остаток после хода
darts - кол-во дротиков в подходе
doubleAttempts - попыток удвоения

Cricket
```json
{ 
    "stage": "game", 
    "key": "Dj4mE", 
    "guid": "8c414046-51a9-1345-a9f1-5f2f136f8711", 
    "require": 1, 
    "darts": 3, 
    "score": { 
        "s15": 0, 
        "s16": 0, 
        "s17": 0, 
        "s18": 0, 
        "s19": 1, 
        "s20": 6, 
        "sBull": 0 
    }, 
}
```
Где
stage - аттрибут стадии 
key - ключ игры полученный от инициатора игры
guid - GUID игры первого или второго Клиента
score - массив с кол-вом попаданий в сектора за подход. 
require - больше нуля. Если закрыты все сектора и кол-во очков больше чем у оппонента, require = 0
darts - кол-во дротиков в подходе




На успешный запрос, сервер посылает "ОК"


В начале каждого лега кроме первого начинающий Клиент, отправляет запрос:

*х01*
```json
{ 
    "stage": "game", 
    "key": "Dj4mE", 
    "guid": "8c414046-51a9-1345-a9f1-5f2f136f8711", 
    "score": 100, 
    "require": 351, 
    "darts": 3, 
    "doubleAttempts": 0,
    "setsPlayer1" : 0,
    "legsPlayer1" : 0,
    "setsPlayer2" : 0,
    "legsPlayer2" : 0
}
```
где, 
...
setsPlayer1 = состояние текущего счета между игроками Сеты игрока 1
legsPlayer1 = состояние текущего счета между игроками Леги игрока 1
setsPlayer2 = состояние текущего счета между игроками Сеты игрока 2
legsPlayer2 = состояние текущего счета между игроками Леги игрока 2


*Cricket*
```json
{ 
    "stage": "game", 
    "key": "Dj4mE", 
    "guid": "8c414046-51a9-1345-a9f1-5f2f136f8711", 
    "require": 1, 
    "darts": 3, 
    "score": { 
        "s15": 0, 
        "s16": 0, 
        "s17": 0, 
        "s18": 0, 
        "s19": 1, 
        "s20": 6, 
        "sBull": 0 
    }, 
    "setsPlayer1": 0, 
    "legsPlayer1": 0, 
    "setsPlayer2": 0, 
    "legsPlayer2": 0 
}
```
где, 
...
setsPlayer1 = состояние текущего счета между игроками Сеты игрока 1
legsPlayer1 = состояние текущего счета между игроками Леги игрока 1
setsPlayer2 = состояние текущего счета между игроками Сеты игрока 2
legsPlayer2 = состояние текущего счета между игроками Леги игрока 2

На успешный запрос, сервер посылает "ОК"

Запрос на получение данных от опонента:
```json
{
    "stage": "game", 
    "key": "Dj4mE", 
    "guid": "8c414046-51a9-1345-a9f1-5f2f136f8711"
}
```

В ответ сервер отправляет набор опонента:

*x01*
```json
{
    "score":"100",
    "darts":"3",
    "doubleAttempts":"0"
} 
```

*Cricket*
```json
{  
    "darts": 3,  
    "score": {  
        "s15": 0,  
        "s16": 0,  
        "s17": 4,  
        "s18": 1,  
        "s19": 0,  
        "s20": 0,  
        "sBull": 0  
    },  
}
```

Либо, если поступили данные об изменении параметров игры от Клиента 1:

*x01*
```json
{
    "score":"100",
    "darts":"3",
    "doubleAttempts":"0",
    "setGame": { 
        "firstToSets": 2, 
        "firstToLegs": 5, 
        "bestOf": 0, 
        "doublesCount": true 
    } 
} 
```

*Cricket*
```json
{  
    "darts": 3,  
    "score": {  
        "s15": 0,  
        "s16": 0,  
        "s17": 4,  
        "s18": 1,  
        "s19": 0,  
        "s20": 0,  
        "sBull": 0  
    },
    "setGame": { 
        "firstToSets": 2, 
        "firstToLegs": 5, 
        "bestOf": 0 
    } 
}
```

Клиент 1 может использовать расширенный запрос, для изменения параметров игры

*x01*
```json
{ 
    "stage": "game", 
    "key": "Dj4mE", 
    "guid": "ac922d72-2963-ab41-8d36-b954f658d71c", 
    "score": 100, 
    "require": 261, 
    "darts": 3, 
    "doubleAttempts": 0, 
    "setGame": { 
        "firstToSets": 2, 
        "firstToLegs": 5, 
        "bestOf": 0, 
        "doublesCount": true 
    } 
}
```

*Cricket*
```json
{ 
    "stage": "game", 
    "key": "Dj4mE", 
    "guid": "8c414046-51a9-1345-a9f1-5f2f136f8711", 
    "require": 1, 
    "darts": 3, 
    "score": { 
        "s15": 0, 
        "s16": 0, 
        "s17": 0, 
        "s18": 0, 
        "s19": 1, 
        "s20": 6, 
        "sBull": 0 
    }, 
    "setGame": { 
        "firstToSets": 2, 
        "firstToLegs": 5, 
        "bestOf": 0
    } 
}
```

в ответ на успешный запрос сервер отправит "ОК"


Для возврата хода Оппоненту, в случае неверно введеных результатов формируется запрос 
```json
{
    "stage": "game", 
    "key": "Dj4mE", 
    "guid": "ac922d72-2963-ab41-8d36-b954f658d71c", 
    "removeLastMove" : true
}
```
При успешном запросе, сервер отправит "OK" вызвавшему клиенту, оппоненту придёт структура

```json
{
    "remove" : true
}
```


Удаление игры
```json
{
    "stage": "game", 
    "key": "Dj4mE", 
    "guid": "ac922d72-2963-ab41-8d36-b954f658d71c", 
    "deleteGame": true 
}
```
Если запрос поступил от иницатора игры до регистрации второго участника, игра удалится сразу, Клиенту 1 будет отправлено "ОК"
При получении запроса сервер ответит "OK" клиенту отправившему запрос, оппоненту будет отправлена структура

```json
{
    "deleteGame" : true
}
```
После отправки оппоненту, запись об игре удалится из БД. 


## Ошибки

Все ошибки в случее удачного соединения, но неверного или неполного запроса приходят от сервера в виде: "error_Текст ошибки" 

"error_Not required Stage" - ошибка в json, поле stage не содержит правильной стадии
"error_Такой GUID уже зарегистрирован в системе и ключ игры выдан" - GUID инициализатора уже получил ключ
"error_Другой игрок уже ответил на вызов" - По ключу игры уже кто-то ответил и зарегистрировался 
"error_Не найдено игры с таким ключом" - Ключ игры указан не верно, или игра уже недействительна
"error_Сейчас ход игрока n" - Игрок пытается послать набор не в свою очередь
"error_Отмена хода уже активирована, жду набор" - Оппонент вызвал отмену хода, необходимо послать новый результат
"error_Нет данных о счете между игроками" - Не переданы обязательные поля при начале следующего лега
"error_Остаток очков 0 или меньше" - в начале нового лега require 0 или меньше
"error_Настройки может изменить только игрок начинающий игру" - Попытка изменить настройки игры от второго игрока. 