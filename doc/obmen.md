# Формат обмена между Дартс-базой и сервером

Клиент 1 - Приложение Дартс-База, инициатор игры
Клиент 2 - Приложение Дартс-База, отвечающий игрок. 
Игрок 1 - Имя игрока на Клиенте 1
Игрок 2 - Имя игрока на клиенте 2

## Формат запроса

Обмен между клиентом и сервером идёт в формате json, обязателен аттрибут stage, в зависимости от стадии процесса.
```json
{
    "key":"value",
}
```

## stage - допустимые состояния

### register

Стадия регистрации.
Дартс-база формирует запрос в виде:
Формат:
```json
{
    "stage": "register", 
    "guid": "ac922d72-2963-ab41-8d36-b954f658d71c",
    "game": "x01",
    "playerName": "Mark"
}
```
где, 
stage - аттрибут стадии
guid - GUID игры создающего игру клиента
game - типа игры, допустимые значения x01, Cricket
playerName - имя Игрока 1

В ответ на запрос возвращается Ключ игры, который используется для согласования игры с вторым клиентом: 5 символов, регистрозависимы, например: "Dj4mE". Ключ необходимо сообщить удаленному игроку. 

После получения ключа Клиент 1 переходит в состояние *wait*

### answer
Стадия регистрации второго клиента. 
```json
{ 
    "stage": "answer", 
    "key": "Dj4mE", 
    "guid": "8c414046-51a9-1345-a9f1-5f2f136f8711", 
    "playerName": "Savage" 
}
```
где, 
stage - аттрибут стадии 
key - ключ игры полученный от инициатора игры
guid - GUID игры клиента желающего сыграть. 
playerName - имя игрока 2

В ответ на запрос Клиент 2 получает имя Игрока 1

### wait
Стадия согласования данных и начала игры
```json
{ 
    "stage": "wait", 
    "key": "Dj4mE", 
    "guid": ""
}
```
где, 
stage - аттрибут стадии 
key - ключ игры полученный от инициатора игры
guid - GUID игры первого или второго Клиента

В ответ Клиенту 1 будет отправлено имя Игрока 2, после получения Игрока 2, Клиент 1 инициализирует игру, стадией *setGame*

Клиенту 2 отправляется ответ с настройками игры, полученными от Клиента 1:
```json
{
    "bestOf": 0, 
    "beginGame": 2, 
    "firstToLegs": 4, 
    "firstToSets": 1, 
    "doublesCount": true, 
    "startScores1": 501, 
    "startScores2": 451
}
```

### setGame
```json
{ 
    "stage": "setGame", 
    "key": "Dj4mE", 
    "beginGame": 2, 
    "firstToSets": 1, 
    "firstToLegs": 3, 
    "bestOf": 0, 
    "doublesCount": true, 
    "startScores1": 501, 
    "startScores2": 451 
}
```

где, 
stage - аттрибут стадии
key - ключ игры
beginGame - номер начинающего игрока, 1 - Клиент 1 (Игрок 1), 2 - Клиент 2 (Игрок 2)
firstToSets - до победы в *value* сетах
firstToLegs - первый до *value* легах
bestOf - лучший из *value* легов
doublesCount - признак подсчет даблов при закрытии (для расширенной статистики на клиентах)
startScores1 - начальное кол-во очков для Игрока 1
startScores2 - начальное кол-во очков для Игрока 2

В ответ на успешный запрос Клиент 1 получает ответ 'OK'

### game

Клиенты 1 и 2 может послать 2 разных запроса

Набор для отпраки опоненту: 
```json
{ 
    "stage": "game", 
    "key": "Dj4mE", 
    "guid": "8c414046-51a9-1345-a9f1-5f2f136f8711", 
    "score": 100, 
    "require": 351, 
    "darts": 3, 
    "doubleAttempts": 0 
}
```
На успешный запрос, сервер посылает "ОК"

Запрос на получение данных от опонента:
```json
{
    "stage": "game", 
    "key": "Dj4mE", 
    "guid": "8c414046-51a9-1345-a9f1-5f2f136f8711"
}
```

В ответ сервер отправляет набор опонента:
```json
{
    "score":"100",
    "darts":"3",
    "doubleAttempts":"0"
} 
```
Либо, если поступили данные об изменении параметров игры от Клиента 1:
```json
{
    "score":"100",
    "darts":"3",
    "doubleAttempts":"0",
    "setGame": { 
        "firstToSets": 2, 
        "firstToLegs": 5, 
        "bestOf": 0, 
        "doublesCount": true 
    } 
} 
```


Клиент 1 может использовать расширенный запрос, для изменения параметров игры
```json
{ 
    "stage": "game", 
    "key": "Dj4mE", 
    "guid": "ac922d72-2963-ab41-8d36-b954f658d71c", 
    "score": 100, 
    "require": 261, 
    "darts": 3, 
    "doubleAttempts": 0, 
    "setGame": { 
        "firstToSets": 2, 
        "firstToLegs": 5, 
        "bestOf": 0, 
        "doublesCount": true 
    } 
}
```

в ответ на успешный запрос сервер отправит "ОК"

